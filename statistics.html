<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交易統計 - 股票資金流向</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        /* ==================== CSS Variables (New Dribbble Inspired Palette) ==================== */
        :root {
            /* Color Palette - Dark Mode */
            --bg-primary: #0D1117;         /* Very dark slate, almost black */
            --bg-card: #161B22;            /* Card background, slightly lighter */
            --bg-elevated: #21262D;        /* Elevated elements like hover states */
            --text-primary: #E6EDF3;       /* Primary text (whitish) */
            --text-secondary: #848D97;     /* Secondary text (greyish) */
            --text-muted: #6E7681;         /* Muted text */

            /* Brand Color */
            --brand-primary: #58A6FF;      /* Bright blue for accents */
            --brand-hover: #7BC0FF;

            /* Semantic Colors - Kept for clarity */
            --color-buy: #3FB950;          /* Green */
            --color-sell: #F85149;         /* Red */
            --color-dividend: #FBBF24;     /* Amber */
            --color-capital: #A371F7;      /* Purple */

            /* Backgrounds for badges - More subtle */
            --bg-buy: rgba(63, 185, 80, 0.15);
            --bg-sell: rgba(248, 81, 73, 0.15);
            --bg-dividend: rgba(251, 191, 36, 0.15);
            --bg-capital: rgba(163, 113, 247, 0.15);

            /* Borders & Shadows */
            --border-color: #30363D;
            --border-light: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 3px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px -3px rgba(0, 0, 0, 0.4);
        }

        /* ==================== Reset & Base ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ==================== Layout ==================== */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* ==================== Header ==================== */
        .header {
            background: var(--bg-primary); /* Same as body */
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav a:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .nav a.active {
            background: rgba(88, 166, 255, 0.15);
            color: var(--brand-primary);
            font-weight: 600;
        }
        
        .btn {
            padding: 10px 20px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }
        .btn-primary:hover { background: var(--brand-hover); }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .btn-secondary:hover { background: #30363D; border-color: #848D97; }

        /* ==================== Section ==================== */
        .section {
            margin-bottom: 24px;
        }

        .section-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
        }

        .section-split {
            display: grid;
            grid-template-columns: 1.2fr 1fr;
            gap: 24px;
            align-items: start;
        }

        .section-split-chart {
            min-width: 0;
        }

        .section-split-details {
            min-width: 0;
        }

        .section-split-details .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .section-split-details table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .section-header {
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .section-header p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        /* ==================== Stats Grid ==================== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(88, 166, 255, 0.1);
        }

        .stat-card .label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .stat-card .value.positive { color: var(--color-buy); }
        .stat-card .value.negative { color: var(--color-sell); }
        
        .stat-card .subtext {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ==================== Table ==================== */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        tbody tr:hover { background-color: var(--bg-elevated); }
        tbody tr:last-child td { border-bottom: none; }
        
        thead {
             background: var(--bg-card); /* To make it solid on scroll */
        }
        
        /* ==================== Amount Colors ==================== */
        .amount-positive { color: var(--color-buy); font-weight: 500; }
        .amount-negative { color: var(--color-sell); font-weight: 500; }
        .amount-neutral { color: var(--brand-primary); font-weight: 500; }
        .stock-code { color: var(--brand-primary); font-weight: 600; }
        
        /* ==================== Empty & Error States ==================== */
        .empty-state { text-align: center; padding: 32px; color: var(--text-muted); }
        .error-message { background: #FEE2E2; color: #991B1B; padding: 16px; border-radius: 6px; text-align: center; }

        /* ==================== Responsive Design ==================== */
        @media (max-width: 1024px) {
            .section-split {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { padding: 16px; }
            .stats-grid { grid-template-columns: 1fr; }
            .stat-card .value { font-size: 1.75rem; }
            th, td { padding: 12px; font-size: 0.875rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>股票資金流向記錄</h1>
            <nav class="nav">
                <a href="stock-tracker.html">交易記錄</a>
                <a href="statistics.html" class="active">統計分析</a>
            </nav>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Overall Statistics -->
        <div class="section">
            <div class="section-card">
                <div class="section-header">
                    <h2>整體統計</h2>
                    <p>總體交易概況與損益分析</p>
                </div>
                <div class="stats-grid" id="overallStats">
                    <div class="empty-state">載入中...</div>
                </div>
            </div>
        </div>

        <!-- Yearly Average Balance -->
        <div class="section">
            <div class="section-card">
                <div class="section-header">
                    <h2>每年平均股市餘額</h2>
                    <p>計算每年在總證券戶的平均持有金額</p>
                </div>
                <div class="table-container" id="yearlyAverageBalance">
                    <div class="empty-state">載入中...</div>
                </div>
            </div>
        </div>

        <!-- Yearly Return Chart -->
        <div class="section">
            <div class="section-card">
                <div class="section-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                    <div>
                        <h2 id="chartTitle">每年報酬率趨勢</h2>
                        <p id="chartDescription">歷年投資報酬率表現</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn btn-primary" id="btnReturnMode" onclick="switchChartMode('return')">報酬率模式</button>
                        <button class="btn btn-secondary" id="btnAssetMode" onclick="switchChartMode('asset')">累積資產模式</button>
                    </div>
                </div>
                <div style="max-width: 900px; margin: 0 auto;">
                    <canvas id="returnChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Yearly Dividend Chart -->
        <div class="section">
            <div class="section-card">
                <div class="section-header">
                    <h2>每年股利統計</h2>
                    <p>歷年股利收入趨勢與明細</p>
                </div>
                <div class="section-split">
                    <div class="section-split-chart">
                        <canvas id="dividendChart"></canvas>
                    </div>
                    <div class="section-split-details">
                        <div class="table-container" id="dividendDetails">
                            <div class="empty-state">載入中...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Inventory -->
        <div class="section">
            <div class="section-card">
                <div class="section-header">
                    <h2>股票目前庫存</h2>
                    <p>持有中的股票明細與未實現損益</p>
                </div>
                <div class="table-container" id="stockInventory">
                    <div class="empty-state">載入中...</div>
                </div>
            </div>
        </div>

        <!-- Stock Statistics -->
        <div class="section">
            <div class="section-card">
                <div class="section-header">
                    <h2>股票統計</h2>
                    <p>各股票交易記錄與投資報酬率</p>
                </div>
                <div class="table-container" id="stockStats">
                    <div class="empty-state">載入中...</div>
                </div>
            </div>
        </div>

        <!-- Account Flow -->
        <div class="section">
            <div class="section-card">
                <div class="section-header">
                    <h2>帳戶資金流向</h2>
                    <p>各證券帳戶資金進出統計</p>
                </div>
                <div class="table-container" id="accountStats">
                    <div class="empty-state">載入中...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSbgsM-j_c69k_zvY9-kT7cpkFZCed7qB9U9ARl8qICGslPo5y6UEAkUw4FIacq7wjUK6HHurDAZODc/pub?output=csv';

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim()); // Trim headers to remove potential whitespace
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue; // Skip rows that don't match header count
                }
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j].trim(); // Trim values
                    // Attempt to convert 'amount' to a number
                    if (headers[j] === 'amount') {
                        obj[headers[j]] = parseFloat(value);
                    } else {
                        obj[headers[j]] = value;
                    }
                }
                result.push(obj);
            }
            return result;
        }

        let transactions = [];
        let currentChartMode = 'return'; // 'return' or 'asset'
        let yearlyDataCache = null; // Cache yearly data for chart mode switching

        // Switch Chart Mode
        function switchChartMode(mode) {
            currentChartMode = mode;

            // Update button styles
            const btnReturn = document.getElementById('btnReturnMode');
            const btnAsset = document.getElementById('btnAssetMode');

            if (mode === 'return') {
                btnReturn.className = 'btn btn-primary';
                btnAsset.className = 'btn btn-secondary';
                document.getElementById('chartTitle').textContent = '每年報酬率趨勢';
                document.getElementById('chartDescription').textContent = '歷年投資報酬率表現';
            } else {
                btnReturn.className = 'btn btn-secondary';
                btnAsset.className = 'btn btn-primary';
                document.getElementById('chartTitle').textContent = '累積資產價值趨勢';
                document.getElementById('chartDescription').textContent = '假設初始投入 NT$ 100,000 的資產成長';
            }

            // Re-render chart with cached data
            if (yearlyDataCache) {
                renderReturnChart(yearlyDataCache);
            }
        }

        // Load Transactions
        async function loadTransactions() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error('無法載入 Google Sheet 資料');
                }
                const csvText = await response.text();
                transactions = parseCSV(csvText); // Use the new parseCSV function
                calculateStatistics();
            } catch (error) {
                console.error('載入資料時發生錯誤:', error);
                document.getElementById('overallStats').innerHTML =
                    '<div class="error-message">無法載入 Google Sheet 交易記錄。請確認連結正確且檔案格式正確。<br>錯誤訊息: ' + error.message + '</div>';
            }
        }

        // Calculate Statistics
        function calculateStatistics() {
            // Overall statistics
            const overallStats = {
                totalBuy: 0,
                totalSell: 0,
                totalDividend: 0,
                tradingProfit: 0,
                netProfit: 0,
                transactionCount: transactions.length,
                currentBalance: 0
            };

            // Stock statistics
            const stockStats = {};

            // Stock inventory
            const stockInventory = {};

            // Account flow
            const accountFlow = {};

            // Sort by date
            const sortedTransactions = [...transactions].sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            let balance = 0;

            sortedTransactions.forEach(t => {
                // Overall stats
                if (t.type === 'buy') {
                    overallStats.totalBuy += t.amount;

                    // 只有買入到總證券戶才增加餘額
                    if (t.to === '總證券戶') {
                        balance += t.amount;
                    }

                    // Account flow
                    if (t.from) {
                        if (!accountFlow[t.from]) accountFlow[t.from] = { in: 0, out: 0 };
                        accountFlow[t.from].out += t.amount;
                    }
                    if (t.to) {
                        if (!accountFlow[t.to]) accountFlow[t.to] = { in: 0, out: 0 };
                        accountFlow[t.to].in += t.amount;
                    }
                } else if (t.type === 'sell') {
                    overallStats.totalSell += t.amount;

                    // 只有從總證券戶賣出才減少餘額
                    if (t.from === '總證券戶') {
                        balance -= t.amount;
                    }

                    // Account flow
                    if (t.from) {
                        if (!accountFlow[t.from]) accountFlow[t.from] = { in: 0, out: 0 };
                        accountFlow[t.from].out += t.amount;
                    }
                    if (t.to) {
                        if (!accountFlow[t.to]) accountFlow[t.to] = { in: 0, out: 0 };
                        accountFlow[t.to].in += t.amount;
                    }
                } else if (t.type === 'dividend') {
                    overallStats.totalDividend += t.amount;
                    // 股利不計入總證券戶餘額
                } else if (t.type === 'capital_gain') {
                    // 買賣價差永遠計入總證券戶餘額
                    balance += t.amount;
                }

                // Stock statistics
                if (t.stockCode && t.stockCode !== '-') {
                    if (!stockStats[t.stockCode]) {
                        stockStats[t.stockCode] = {
                            buyAmount: 0,
                            sellAmount: 0,
                            otherIncome: 0,  // 包含股利與資本利得
                            netProfit: 0
                        };
                    }

                    if (t.type === 'buy') {
                        stockStats[t.stockCode].buyAmount += t.amount;
                    } else if (t.type === 'sell') {
                        stockStats[t.stockCode].sellAmount += t.amount;
                    } else if (t.type === 'dividend') {
                        stockStats[t.stockCode].otherIncome += t.amount;
                    } else if (t.type === 'capital_gain') {
                        stockStats[t.stockCode].otherIncome += t.amount;
                    }

                    // Stock inventory
                    if (!stockInventory[t.stockCode]) {
                        stockInventory[t.stockCode] = {
                            invested: 0,
                            returned: 0,
                            otherIncome: 0,  // 包含股利與資本利得
                            balance: 0
                        };
                    }

                    if (t.type === 'buy') {
                        stockInventory[t.stockCode].invested += t.amount;
                        stockInventory[t.stockCode].balance += t.amount;
                    } else if (t.type === 'sell') {
                        stockInventory[t.stockCode].returned += t.amount;
                        stockInventory[t.stockCode].balance -= t.amount;
                    } else if (t.type === 'dividend') {
                        // 股利是现金收益，不影响库存余额
                        stockInventory[t.stockCode].otherIncome += t.amount;
                    } else if (t.type === 'capital_gain') {
                        // 资本利得影响库存余额（买卖价差调整持股成本）
                        stockInventory[t.stockCode].otherIncome += t.amount;
                        stockInventory[t.stockCode].balance += t.amount;
                    }
                }
            });

            // Calculate net profit for each stock
            let totalInventoryCost = 0;

            Object.keys(stockStats).forEach(stock => {
                const stats = stockStats[stock];
                stats.netProfit = stats.sellAmount - stats.buyAmount + stats.otherIncome;

                // Calculate inventory cost
                if (stats.buyAmount > stats.sellAmount) {
                    const inventoryCost = stats.buyAmount - stats.sellAmount;
                    totalInventoryCost += inventoryCost;
                }
            });

            // Trading profit = total sell - total buy + inventory cost
            overallStats.tradingProfit = overallStats.totalSell - overallStats.totalBuy + totalInventoryCost;

            // Net profit = trading profit + dividend
            overallStats.netProfit = overallStats.tradingProfit + overallStats.totalDividend;

            overallStats.currentBalance = balance;

            // Calculate annualized return based on realized gains only
            if (sortedTransactions.length > 0) {
                const firstDate = new Date(sortedTransactions[0].date);
                const lastDate = new Date(sortedTransactions[sortedTransactions.length - 1].date);
                const today = new Date();
                const endDate = lastDate > today ? lastDate : today;

                const daysDiff = (endDate - firstDate) / (1000 * 60 * 60 * 24);
                const years = daysDiff / 365.25;

                // Calculate total realized income (dividends + capital gains)
                let totalRealizedIncome = 0;
                sortedTransactions.forEach(t => {
                    if (t.type === 'dividend' || t.type === 'capital_gain') {
                        totalRealizedIncome += t.amount;
                    }
                });

                // Calculate average balance over the entire period
                const balanceByDate = {};
                let currentBalance = 0;
                sortedTransactions.forEach(t => {
                    if (t.type === 'buy' && t.to === '總證券戶') {
                        currentBalance += t.amount;
                    } else if (t.type === 'sell' && t.from === '總證券戶') {
                        currentBalance -= t.amount;
                    } else if (t.type === 'capital_gain') {
                        currentBalance += t.amount;
                    }
                    balanceByDate[t.date] = currentBalance;
                });

                // Fill all dates and calculate average
                let totalBalanceSum = 0;
                let dayCount = 0;
                const currentDate = new Date(firstDate);
                let lastKnownBalance = 0;

                while (currentDate <= endDate) {
                    const dateStr = currentDate.toISOString().split('T')[0];
                    if (balanceByDate[dateStr] !== undefined) {
                        lastKnownBalance = balanceByDate[dateStr];
                    }
                    totalBalanceSum += lastKnownBalance;
                    dayCount++;
                    currentDate.setDate(currentDate.getDate() + 1);
                }

                const averageBalance = dayCount > 0 ? totalBalanceSum / dayCount : 0;

                // Annualized return = (total realized income / average balance) / years
                if (averageBalance > 0 && years > 0) {
                    const totalReturn = totalRealizedIncome / averageBalance;
                    const annualizedReturn = (totalReturn / years) * 100;
                    overallStats.annualizedReturn = annualizedReturn.toFixed(2);
                    overallStats.investmentYears = years.toFixed(2);
                } else {
                    overallStats.annualizedReturn = '0.00';
                    overallStats.investmentYears = '0.00';
                }
            } else {
                overallStats.annualizedReturn = '0.00';
                overallStats.investmentYears = '0.00';
            }

            renderStatistics(overallStats, stockStats, stockInventory, accountFlow);
        }

        // Render Statistics
        function renderStatistics(overallStats, stockStats, stockInventory, accountFlow) {
            // Overall Statistics
            const overallHTML = `
                <div class="stat-card">
                    <div class="label">總交易筆數</div>
                    <div class="value">${overallStats.transactionCount}</div>
                    <div class="subtext">筆</div>
                </div>
                <div class="stat-card">
                    <div class="label">總買入金額</div>
                    <div class="value negative">NT$ ${overallStats.totalBuy.toLocaleString()}</div>
                    <div class="subtext">投入成本</div>
                </div>
                <div class="stat-card">
                    <div class="label">總賣出金額</div>
                    <div class="value positive">NT$ ${overallStats.totalSell.toLocaleString()}</div>
                    <div class="subtext">回收資金</div>
                </div>
                <div class="stat-card">
                    <div class="label">已實現總損益</div>
                    <div class="value ${overallStats.netProfit >= 0 ? 'positive' : 'negative'}">NT$ ${overallStats.netProfit.toLocaleString()}</div>
                    <div class="subtext">價差 + 股利 (排除庫存)</div>
                </div>
                <div class="stat-card">
                    <div class="label">年化報酬率</div>
                    <div class="value ${overallStats.annualizedReturn >= 0 ? 'positive' : 'negative'}">${overallStats.annualizedReturn}%</div>
                    <div class="subtext">${overallStats.investmentYears} 年投資期間</div>
                </div>
            `;

            document.getElementById('overallStats').innerHTML = overallHTML;

            // Stock Inventory
            const stockInventoryArray = Object.entries(stockInventory)
                .map(([stock, inv]) => ({
                    stock,
                    ...inv
                }))
                .filter(s => s.balance > 0)
                .sort((a, b) => b.balance - a.balance);

            const inventoryHTML = stockInventoryArray.length > 0 ? `
                <table>
                    <thead>
                        <tr>
                            <th>股票代碼</th>
                            <th>投入成本</th>
                            <th>已回收</th>
                            <th>股利與價差</th>
                            <th>目前餘額</th>
                            <th>未實現損益</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stockInventoryArray.map(s => {
                            const unrealizedProfit = s.balance - s.invested + s.returned;
                            const unrealizedClass = unrealizedProfit >= 0 ? 'amount-positive' : 'amount-negative';

                            return `
                                <tr>
                                    <td><strong>${s.stock}</strong></td>
                                    <td class="amount-negative">NT$ ${s.invested.toLocaleString()}</td>
                                    <td class="amount-positive">NT$ ${s.returned.toLocaleString()}</td>
                                    <td class="${s.otherIncome >= 0 ? 'amount-positive' : 'amount-negative'}">NT$ ${s.otherIncome.toLocaleString()}</td>
                                    <td class="amount-neutral">NT$ ${s.balance.toLocaleString()}</td>
                                    <td class="${unrealizedClass}">NT$ ${unrealizedProfit.toLocaleString()}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            ` : '<div class="empty-state">目前無持有任何股票</div>';

            document.getElementById('stockInventory').innerHTML = inventoryHTML;

            // Stock Statistics
            const stockStatsArray = Object.entries(stockStats).map(([stock, stats]) => ({
                stock,
                ...stats
            })).sort((a, b) => b.netProfit - a.netProfit);

            const stockTableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>股票代碼</th>
                            <th>買入金額</th>
                            <th>賣出金額</th>
                            <th>股利與價差</th>
                            <th>淨損益</th>
                            <th>投資報酬率</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stockStatsArray.map(s => {
                            const roi = s.buyAmount > 0 ? ((s.netProfit / s.buyAmount) * 100).toFixed(2) : 0;
                            const roiClass = roi >= 0 ? 'amount-positive' : 'amount-negative';
                            const profitClass = s.netProfit >= 0 ? 'amount-positive' : 'amount-negative';

                            return `
                                <tr>
                                    <td><strong>${s.stock}</strong></td>
                                    <td class="amount-negative">NT$ ${s.buyAmount.toLocaleString()}</td>
                                    <td class="amount-positive">NT$ ${s.sellAmount.toLocaleString()}</td>
                                    <td class="${s.otherIncome >= 0 ? 'amount-positive' : 'amount-negative'}">NT$ ${s.otherIncome.toLocaleString()}</td>
                                    <td class="${profitClass}">NT$ ${s.netProfit.toLocaleString()}</td>
                                    <td class="${roiClass}">${roi}%</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('stockStats').innerHTML = stockTableHTML;

            // Account Flow
            const accountHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>帳戶名稱</th>
                            <th>流入金額</th>
                            <th>流出金額</th>
                            <th>淨流向</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(accountFlow).map(([account, flow]) => {
                            const net = flow.in - flow.out;
                            const netClass = net >= 0 ? 'amount-positive' : 'amount-negative';

                            return `
                                <tr>
                                    <td><strong>${account}</strong></td>
                                    <td class="amount-positive">NT$ ${flow.in.toLocaleString()}</td>
                                    <td class="amount-negative">NT$ ${flow.out.toLocaleString()}</td>
                                    <td class="${netClass}">NT$ ${net.toLocaleString()}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('accountStats').innerHTML = accountHTML;

            // Render Yearly Average Balance
            renderYearlyAverageBalance();

            // Render Dividend Chart
            renderDividendChart();
        }

        // Calculate and Render Yearly Average Balance
        function renderYearlyAverageBalance() {
            // Sort transactions by date
            const sortedTransactions = [...transactions].sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            if (sortedTransactions.length === 0) {
                document.getElementById('yearlyAverageBalance').innerHTML =
                    '<div class="empty-state">尚無交易記錄</div>';
                return;
            }

            // Get date range
            const firstDate = new Date(sortedTransactions[0].date);
            const lastDate = new Date(sortedTransactions[sortedTransactions.length - 1].date);
            const today = new Date();
            const endDate = lastDate > today ? lastDate : today;

            // Build balance timeline (date -> balance mapping)
            const balanceByDate = {};
            let currentBalance = 0;

            sortedTransactions.forEach(t => {
                const date = new Date(t.date);
                const dateStr = t.date;

                // Update balance based on transaction type
                if (t.type === 'buy' && t.to === '總證券戶') {
                    currentBalance += t.amount;
                } else if (t.type === 'sell' && t.from === '總證券戶') {
                    currentBalance -= t.amount;
                } else if (t.type === 'capital_gain') {
                    currentBalance += t.amount;
                }
                // Note: dividend does not count towards balance

                balanceByDate[dateStr] = currentBalance;
            });

            // Calculate yearly average
            const yearlyData = {};

            // Fill in all dates from first transaction to today
            const currentDate = new Date(firstDate);
            let lastKnownBalance = 0;

            while (currentDate <= endDate) {
                const dateStr = currentDate.toISOString().split('T')[0];
                const year = currentDate.getFullYear();

                // Update balance if there was a transaction on this date
                if (balanceByDate[dateStr] !== undefined) {
                    lastKnownBalance = balanceByDate[dateStr];
                }

                // Initialize year data
                if (!yearlyData[year]) {
                    yearlyData[year] = {
                        totalBalance: 0,
                        dayCount: 0,
                        startBalance: lastKnownBalance,
                        endBalance: lastKnownBalance,
                        maxBalance: lastKnownBalance,
                        minBalance: lastKnownBalance
                    };
                }

                // Add to yearly totals
                yearlyData[year].totalBalance += lastKnownBalance;
                yearlyData[year].dayCount++;
                yearlyData[year].endBalance = lastKnownBalance;

                // Track max and min
                if (lastKnownBalance > yearlyData[year].maxBalance) {
                    yearlyData[year].maxBalance = lastKnownBalance;
                }
                if (lastKnownBalance < yearlyData[year].minBalance) {
                    yearlyData[year].minBalance = lastKnownBalance;
                }

                // Move to next day
                currentDate.setDate(currentDate.getDate() + 1);
            }

            // Calculate averages and prepare display
            const yearlyArray = Object.entries(yearlyData)
                .map(([year, data]) => ({
                    year,
                    averageBalance: data.totalBalance / data.dayCount,
                    startBalance: data.startBalance,
                    endBalance: data.endBalance,
                    maxBalance: data.maxBalance,
                    minBalance: data.minBalance,
                    dayCount: data.dayCount
                }))
                .sort((a, b) => b.year - a.year); // Most recent first

            // Calculate yearly returns
            yearlyArray.forEach((yearData, index) => {
                // Get transactions for this year
                const yearTransactions = sortedTransactions.filter(t => {
                    const txYear = new Date(t.date).getFullYear();
                    return txYear == yearData.year;
                });

                // Calculate income for this year (dividends + capital gains realized)
                let yearlyIncome = 0;
                yearTransactions.forEach(t => {
                    if (t.type === 'dividend' || t.type === 'capital_gain') {
                        yearlyIncome += t.amount;
                    }
                });

                // Annual return = yearly income / average balance
                // This only measures actual returns (dividends + capital gains), not affected by capital flows
                if (yearData.averageBalance > 0) {
                    const annualReturn = (yearlyIncome / yearData.averageBalance) * 100;
                    yearData.annualReturn = annualReturn.toFixed(2);
                } else {
                    yearData.annualReturn = '-';
                }

                yearData.yearlyIncome = yearlyIncome;
            });

            // Render table
            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>年份</th>
                            <th>平均餘額</th>
                            <th>期初餘額</th>
                            <th>期末餘額</th>
                            <th>當年收益</th>
                            <th>年報酬率</th>
                            <th>最高餘額</th>
                            <th>最低餘額</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${yearlyArray.map(y => {
                            const avgClass = y.averageBalance >= 0 ? 'amount-positive' : 'amount-negative';
                            const endClass = y.endBalance >= 0 ? 'amount-positive' : 'amount-negative';
                            const incomeClass = y.yearlyIncome >= 0 ? 'amount-positive' : 'amount-negative';
                            const returnClass = y.annualReturn !== '-' && parseFloat(y.annualReturn) >= 0 ? 'amount-positive' : 'amount-negative';

                            return `
                                <tr>
                                    <td><strong>${y.year}</strong></td>
                                    <td class="${avgClass}">NT$ ${Math.round(y.averageBalance).toLocaleString()}</td>
                                    <td class="amount-neutral">NT$ ${y.startBalance.toLocaleString()}</td>
                                    <td class="${endClass}">NT$ ${y.endBalance.toLocaleString()}</td>
                                    <td class="${incomeClass}">NT$ ${y.yearlyIncome.toLocaleString()}</td>
                                    <td class="${returnClass}">${y.annualReturn !== '-' ? y.annualReturn + '%' : '-'}</td>
                                    <td class="amount-positive">NT$ ${y.maxBalance.toLocaleString()}</td>
                                    <td class="amount-neutral">NT$ ${y.minBalance.toLocaleString()}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('yearlyAverageBalance').innerHTML = tableHTML;

            // Cache yearly data for chart mode switching
            yearlyDataCache = yearlyArray;

            // Render Yearly Return Chart with the calculated data
            renderReturnChart(yearlyArray);
        }

        // Render Yearly Return Chart
        function renderReturnChart(yearlyArray) {
            // Sort by year (oldest first for chart)
            const sortedByYear = [...yearlyArray].sort((a, b) => a.year - b.year);

            // Filter out years with no valid return data
            const validData = sortedByYear.filter(y => y.annualReturn !== '-');

            const years = validData.map(y => y.year);
            const returns = validData.map(y => parseFloat(y.annualReturn));

            // Calculate bank deposit return (1.5% annual, compounded monthly)
            // Formula: (1 + r/n)^n - 1, where r = 0.015, n = 12
            const monthlyRate = 0.015 / 12;
            const bankReturn = (Math.pow(1 + monthlyRate, 12) - 1) * 100;
            const bankReturns = years.map(() => bankReturn);

            // Prepare data based on current mode
            let stockData, bankData, yAxisLabel, tooltipSuffix;

            if (currentChartMode === 'asset') {
                // Cumulative asset mode - calculate asset value over time
                const initialAmount = 100000;
                let stockAsset = initialAmount;
                let bankAsset = initialAmount;

                const stockAssets = [];
                const bankAssets = [];

                returns.forEach((returnRate, index) => {
                    // Apply return to stock asset
                    stockAsset = stockAsset * (1 + returnRate / 100);
                    stockAssets.push(stockAsset);

                    // Apply bank return
                    bankAsset = bankAsset * (1 + bankReturn / 100);
                    bankAssets.push(bankAsset);
                });

                stockData = stockAssets;
                bankData = bankAssets;
                yAxisLabel = 'NT$';
                tooltipSuffix = '';
            } else {
                // Return rate mode
                stockData = returns;
                bankData = bankReturns;
                yAxisLabel = '';
                tooltipSuffix = '%';
            }

            // Create chart
            const ctx = document.getElementById('returnChart');

            // Destroy existing chart if it exists
            if (window.returnChartInstance) {
                window.returnChartInstance.destroy();
            }

            // Custom plugin to draw labels on data points
            const returnLabelsPlugin = {
                id: 'returnLabels',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;

                    chart.data.datasets.forEach((dataset, datasetIndex) => {
                        const meta = chart.getDatasetMeta(datasetIndex);

                        // In return mode, only label stock data (first dataset)
                        // In asset mode, label both datasets
                        if (currentChartMode === 'return' && datasetIndex !== 0) {
                            return;
                        }

                        meta.data.forEach((point, index) => {
                            const value = dataset.data[index];

                            // Set text style based on dataset
                            if (currentChartMode === 'asset') {
                                ctx.fillStyle = datasetIndex === 0 ? '#6366F1' : '#FBBF24';
                                ctx.font = 'bold 11px -apple-system, BlinkMacSystemFont, "Segoe UI"';
                            } else {
                                ctx.fillStyle = value >= 0 ? '#10B981' : '#F43F5E';
                                ctx.font = 'bold 11px -apple-system, BlinkMacSystemFont, "Segoe UI"';
                            }
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';

                            // Draw text above point
                            let text;
                            if (currentChartMode === 'asset') {
                                text = 'NT$ ' + Math.round(value).toLocaleString();
                            } else {
                                text = value.toFixed(2) + '%';
                            }

                            // Offset position for bank data to avoid overlap
                            const yOffset = (currentChartMode === 'asset' && datasetIndex === 1) ? -18 : -8;
                            ctx.fillText(text, point.x, point.y + yOffset);
                        });
                    });
                }
            };

            window.returnChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: years,
                    datasets: [{
                        label: currentChartMode === 'asset' ? '股票投資資產價值' : '股票投資報酬率 (%)',
                        data: stockData,
                        borderColor: '#6366F1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 3,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: currentChartMode === 'asset' ? '#6366F1' : returns.map(r => r >= 0 ? '#10B981' : '#F43F5E'),
                        pointBorderColor: '#F1F5F9',
                        pointBorderWidth: 2,
                        pointRadius: 6,
                        pointHoverRadius: 8,
                        pointHoverBackgroundColor: currentChartMode === 'asset' ? '#6366F1' : returns.map(r => r >= 0 ? '#10B981' : '#F43F5E'),
                        pointHoverBorderColor: '#F1F5F9',
                        pointHoverBorderWidth: 3,
                    }, {
                        label: currentChartMode === 'asset' ? '銀行定存資產價值 (1.5% 年利率，每月複利)' : '銀行定存報酬率 (1.5% 年利率，每月複利)',
                        data: bankData,
                        borderColor: '#FBBF24',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        borderDash: [8, 4],
                        tension: 0,
                        fill: false,
                        pointRadius: currentChartMode === 'asset' ? 5 : 0,
                        pointHoverRadius: currentChartMode === 'asset' ? 7 : 5,
                        pointBackgroundColor: '#FBBF24',
                        pointBorderColor: '#F1F5F9',
                        pointBorderWidth: currentChartMode === 'asset' ? 2 : 0,
                        pointHoverBackgroundColor: '#FBBF24',
                        pointHoverBorderColor: '#F1F5F9',
                        pointHoverBorderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#F1F5F9',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#F1F5F9',
                            bodyColor: '#F1F5F9',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (currentChartMode === 'asset') {
                                        return label + ': NT$ ' + Math.round(context.parsed.y).toLocaleString();
                                    } else {
                                        return label + ': ' + context.parsed.y.toFixed(2) + '%';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 65, 85, 0.5)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94A3B8',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    if (currentChartMode === 'asset') {
                                        return 'NT$ ' + Math.round(value).toLocaleString();
                                    } else {
                                        return value.toFixed(0) + '%';
                                    }
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(51, 65, 85, 0.3)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#F1F5F9',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                },
                plugins: [returnLabelsPlugin]
            });
        }

        // Render Dividend Details Table
        function renderDividendDetails(years, amounts, dividendByYear) {
            const container = document.getElementById('dividendDetails');

            // Get all dividend transactions
            const dividendTransactions = transactions
                .filter(t => t.type === 'dividend')
                .map(t => ({
                    date: t.date,
                    year: new Date(t.date).getFullYear(),
                    stockCode: t.stockCode || '-',
                    amount: t.amount,
                    note: t.note || ''
                }))
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Newest first

            if (dividendTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state">尚無股利記錄</div>';
                return;
            }

            // Calculate total
            const total = dividendTransactions.reduce((sum, t) => sum + t.amount, 0);

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>股票</th>
                            <th>金額</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${dividendTransactions.map(t => {
                            return `
                                <tr>
                                    <td>${t.date}</td>
                                    <td><span class="stock-code">${t.stockCode}</span></td>
                                    <td class="amount-dividend">NT$ ${t.amount.toLocaleString()}</td>
                                </tr>
                            `;
                        }).join('')}
                        <tr style="border-top: 2px solid var(--border-light); font-weight: bold;">
                            <td colspan="2"><strong>總計</strong></td>
                            <td class="amount-dividend">NT$ ${total.toLocaleString()}</td>
                        </tr>
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // Render Yearly Dividend Chart
        function renderDividendChart() {
            // Group dividends by year
            const dividendByYear = {};

            transactions.forEach(t => {
                if (t.type === 'dividend') {
                    const year = new Date(t.date).getFullYear();
                    if (!dividendByYear[year]) {
                        dividendByYear[year] = 0;
                    }
                    dividendByYear[year] += t.amount;
                }
            });

            // Sort years
            const years = Object.keys(dividendByYear).sort();
            const amounts = years.map(year => dividendByYear[year]);

            // Render dividend details table
            renderDividendDetails(years, amounts, dividendByYear);

            // Create chart
            const ctx = document.getElementById('dividendChart');

            // Destroy existing chart if it exists
            if (window.dividendChartInstance) {
                window.dividendChartInstance.destroy();
            }

            // Custom plugin to draw labels on top of bars
            const topLabelsPlugin = {
                id: 'topLabels',
                afterDatasetsDraw(chart) {
                    const ctx = chart.ctx;
                    chart.data.datasets.forEach((dataset, i) => {
                        const meta = chart.getDatasetMeta(i);
                        meta.data.forEach((bar, index) => {
                            const value = dataset.data[index];

                            // Set text style
                            ctx.fillStyle = '#FBBF24';
                            ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI"';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'bottom';

                            // Draw text above bar
                            const text = 'NT$ ' + value.toLocaleString();
                            ctx.fillText(text, bar.x, bar.y - 5);
                        });
                    });
                }
            };

            window.dividendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: years,
                    datasets: [{
                        label: '股利收入 (NT$)',
                        data: amounts,
                        backgroundColor: 'rgba(251, 191, 36, 0.6)',
                        borderColor: 'rgba(251, 191, 36, 1)',
                        borderWidth: 2,
                        borderRadius: 6,
                        hoverBackgroundColor: 'rgba(251, 191, 36, 0.8)',
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 2.5,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#F1F5F9',
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(30, 41, 59, 0.95)',
                            titleColor: '#F1F5F9',
                            bodyColor: '#F1F5F9',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            callbacks: {
                                label: function(context) {
                                    return '股利收入: NT$ ' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(51, 65, 85, 0.5)',
                                drawBorder: false
                            },
                            ticks: {
                                color: '#94A3B8',
                                font: {
                                    size: 11
                                },
                                callback: function(value) {
                                    return 'NT$ ' + value.toLocaleString();
                                }
                            }
                        },
                        x: {
                            grid: {
                                display: false,
                                drawBorder: false
                            },
                            ticks: {
                                color: '#F1F5F9',
                                font: {
                                    size: 12,
                                    weight: '600'
                                }
                            }
                        }
                    }
                },
                plugins: [topLabelsPlugin]
            });
        }

        // Initialize
        loadTransactions();
    </script>
</body>
</html>
