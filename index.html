<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>股票資金流向記錄</title>
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
    <style>
        /* ==================== CSS Variables (New Dribbble Inspired Palette) ==================== */
        :root {
            /* Color Palette - Dark Mode */
            --bg-primary: #0D1117;         /* Very dark slate, almost black */
            --bg-card: #161B22;            /* Card background, slightly lighter */
            --bg-elevated: #21262D;        /* Elevated elements like hover states */
            --text-primary: #E6EDF3;       /* Primary text (whitish) */
            --text-secondary: #848D97;     /* Secondary text (greyish) */
            --text-muted: #6E7681;         /* Muted text */

            /* Brand Color */
            --brand-primary: #58A6FF;      /* Bright blue for accents */
            --brand-hover: #7BC0FF;

            /* Semantic Colors - Kept for clarity */
            --color-buy: #3FB950;          /* Green */
            --color-sell: #F85149;         /* Red */
            --color-dividend: #FBBF24;     /* Amber */
            --color-capital: #A371F7;      /* Purple */

            /* Backgrounds for badges - More subtle */
            --bg-buy: rgba(63, 185, 80, 0.15);
            --bg-sell: rgba(248, 81, 73, 0.15);
            --bg-dividend: rgba(251, 191, 36, 0.15);
            --bg-capital: rgba(163, 113, 247, 0.15);

            /* Borders & Shadows */
            --border-color: #30363D;
            --border-light: #475569;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.2);
            --shadow-md: 0 3px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 8px 16px -3px rgba(0, 0, 0, 0.4);
        }

        /* ==================== Reset & Base ==================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        /* ==================== Layout ==================== */
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }

        /* NO MORE SIDEBAR */
        .main-content {
            width: 100%;
        }

        /* ==================== Header ==================== */
        .header {
            background: var(--bg-primary); /* Same as body */
            border-bottom: 1px solid var(--border-color);
            padding: 16px 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .header h1 {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .nav {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav a {
            color: var(--text-secondary);
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
        }

        .nav a:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .nav a.active {
            background: rgba(88, 166, 255, 0.15);
            color: var(--brand-primary);
            font-weight: 600;
        }

        /* ==================== Dashboard Summary Cards ==================== */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0 15px rgba(88, 166, 255, 0.1);
        }

        .stat-card .label {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1.2;
        }

        .stat-card .value.positive { color: var(--color-buy); }
        .stat-card .value.negative { color: var(--color-sell); }

        .stat-card .subtext {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        /* ==================== Main Table Section ==================== */
        .table-section {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .table-header h2 {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .record-count {
            font-size: 0.875rem;
            color: var(--text-muted);
            background: var(--bg-elevated);
            padding: 4px 12px;
            border-radius: 6px;
        }
        
        /* Filters will go here */
        .filters {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group { flex: 1; min-width: 150px; }
        
        .filter-group label { display: none; /* Hidden for cleaner look */ }

        .filter-group select, .filter-group input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 0.875rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.2s;
        }
        
        .filter-group select:focus, .filter-group input:focus {
            outline: none;
            border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }

        .filter-actions {
            display: flex;
            gap: 12px;
        }
        
        .btn {
            padding: 10px 20px;
            border: 1px solid transparent;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--brand-primary);
            color: var(--bg-primary);
            border-color: var(--brand-primary);
        }
        .btn-primary:hover { background: var(--brand-hover); }

        .btn-secondary {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        .btn-secondary:hover { background: #30363D; border-color: #848D97; }

        /* ==================== Table (New Design) ==================== */
        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            font-weight: 600;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tbody tr { transition: background-color 0.15s; }
        tbody tr:hover { background-color: var(--bg-elevated); }
        tbody tr:last-child td { border-bottom: none; }

        /* ==================== Type Badges (New Design) ==================== */
        .type-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 15px; /* Pill shape */
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
        }

        .type-badge.buy { background: var(--bg-buy); color: var(--color-buy); }
        .type-badge.sell { background: var(--bg-sell); color: var(--color-sell); }
        .type-badge.dividend { background: var(--bg-dividend); color: var(--color-dividend); }
        .type-badge.capital_gain { background: var(--bg-capital); color: var(--color-capital); }
        
        /* ==================== Amount Colors ==================== */
        .amount-buy { color: var(--color-sell); font-weight: 500; }
        .amount-sell { color: var(--color-buy); font-weight: 500; }
        .amount-dividend { color: var(--color-dividend); font-weight: 500; }
        .amount-capital-gain { color: var(--color-capital); font-weight: 500; }
        .amount-positive { color: var(--color-buy); }
        .amount-negative { color: var(--color-sell); }

        .stock-code { color: var(--brand-primary); font-weight: 600; }

        /* ==================== Modal Styles (Copied from previous step) ==================== */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); display: flex; align-items: center;
            justify-content: center; z-index: 1000; backdrop-filter: blur(5px);
        }
        .modal-content {
            background: var(--bg-card); padding: 24px; border-radius: 12px;
            width: 90%; max-width: 600px; box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }
        .modal-content h2 { font-size: 1.25rem; margin-bottom: 24px; color: var(--text-primary); }
        .modal-content .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .modal-content .form-group { display: flex; flex-direction: column; }
        .modal-content .form-group-full { grid-column: 1 / -1; }
        .modal-content .form-group label { margin-bottom: 8px; font-weight: 500; color: var(--text-secondary); font-size: 0.875rem; }
        .modal-content .form-group input, .modal-content .form-group select {
            width: 100%; padding: 10px 12px; border: 1px solid var(--border-color);
            border-radius: 6px; font-size: 0.875rem; background: var(--bg-primary);
            color: var(--text-primary); transition: all 0.2s;
        }
        .modal-content .form-group input:focus, .modal-content .form-group select:focus {
            outline: none; border-color: var(--brand-primary);
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.2);
        }
        .modal-actions { display: flex; justify-content: flex-end; gap: 16px; margin-top: 24px; }
        .modal-footer-note { font-size: 0.75rem; color: var(--text-muted); margin-top: 16px; text-align: center; }

        /* ==================== Empty & Error States ==================== */
        .empty-state { text-align: center; padding: 32px; color: var(--text-muted); }
        .error-message { background: #FEE2E2; color: #991B1B; padding: 16px; border-radius: 6px; text-align: center; }

        /* ==================== Responsive Design ==================== */
        @media (max-width: 768px) {
            .container { padding: 16px; }
            .header { padding: 16px; }
            .dashboard { grid-template-columns: 1fr; }
            .stat-card .value { font-size: 1.75rem; }
            th, td { padding: 12px; font-size: 0.875rem; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <h1>股票資金流向記錄</h1>
            <nav class="nav">
                <a href="index.html" class="active">交易記錄</a>
                <a href="statistics.html">統計分析</a>
                <button id="authButton" class="btn btn-secondary" style="margin-left: 16px;">授權 Google Sheet 寫入權限</button>
                <button id="signoutButton" class="btn btn-secondary" style="display: none; margin-left: 16px;">取消授權</button>
                <button id="addTransactionBtn" class="btn btn-primary" style="display: none; margin-left: 8px;">新增交易</button>
            </nav>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Summary -->
            <div class="dashboard" id="dashboard">
                <div class="stat-card">
                    <div class="label">總交易筆數</div>
                    <div class="value" id="totalTransactions">-</div>
                    <div class="subtext">累計交易</div>
                </div>
                <div class="stat-card">
                    <div class="label">總投入成本</div>
                    <div class="value negative" id="totalInvested">NT$ -</div>
                    <div class="subtext">買入總額</div>
                </div>
                <div class="stat-card">
                    <div class="label">已回收資金</div>
                    <div class="value positive" id="totalReturned">NT$ -</div>
                    <div class="subtext">賣出總額</div>
                </div>
                <div class="stat-card">
                    <div class="label">已實現損益</div>
                    <div class="value" id="realizedProfit">NT$ -</div>
                    <div class="subtext">價差 + 股利</div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="table-section">
                <div class="table-header">
                    <h2>交易記錄</h2>
                    <span class="record-count" id="recordCount">載入中...</span>
                </div>

                <!-- Filters (Moved from Sidebar) -->
                <div class="filters">
                    <div class="filter-group">
                        <label for="stockFilter">股票代碼</label>
                        <select id="stockFilter">
                            <option value="">全部股票</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="brokerFilter">證券商</label>
                        <select id="brokerFilter">
                            <option value="">全部證券商</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="typeFilter">交易類型</label>
                        <select id="typeFilter">
                            <option value="">全部類型</option>
                            <option value="buy">買入</option>
                            <option value="sell">賣出</option>
                            <option value="dividend">現金股利</option>
                            <option value="capital_gain">買賣價差</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="noteFilter">備註</label>
                        <select id="noteFilter">
                            <option value="">全部備註</option>
                        </select>
                    </div>
                    <div class="filter-actions">
                        <button class="btn btn-primary" onclick="applyFilters()">篩選</button>
                        <button class="btn btn-secondary" onclick="resetFilters()">重置</button>
                    </div>
                </div>

                <div class="table-container" id="tableContainer">
                    <div class="empty-state">載入資料中...</div>
                </div>
            </div>
                </main>
            </div>
        
            <!-- Add Transaction Modal -->
            <div id="addModal" class="modal-overlay" style="display: none;">
                <div class="modal-content">
                    <form id="addTransactionForm">
                        <h2>新增交易紀錄</h2>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="form-date">日期</label>
                                <input type="date" id="form-date" required>
                            </div>
                            <div class="form-group">
                                <label for="form-type">類型</label>
                                <select id="form-type" required>
                                    <option value="buy">買入</option>
                                    <option value="sell">賣出</option>
                                    <option value="dividend">現金股利</option>
                                    <option value="capital_gain">買賣價差</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="form-stockCode">股票代碼</label>
                                <input type="text" id="form-stockCode" placeholder="例如：台積電">
                            </div>
                            <div class="form-group">
                                <label for="form-amount">金額</label>
                                <input type="number" id="form-amount" required placeholder="請輸入數字">
                            </div>
                            <div class="form-group">
                                <label for="form-from">來源</label>
                                <input type="text" id="form-from" placeholder="例如：新光證券">
                            </div>
                            <div class="form-group">
                                <label for="form-to">目的</label>
                                <input type="text" id="form-to" placeholder="例如：總證券戶">
                            </div>
                            <div class="form-group form-group-full">
                                <label for="form-note">備註</label>
                                <input type="text" id="form-note" placeholder="可選填">
                            </div>
                        </div>
                        <div class="modal-actions">
                            <button type="submit" class="btn btn-primary">儲存至 Google Sheet</button>
                            <button type="button" id="cancelBtn" class="btn btn-secondary">取消</button>
                        </div>
                        <p class="modal-footer-note">注意：點擊儲存後，此筆交易將會新增至您的 Google Sheet 中。</p>
                    </form>
                </div>
            </div>
        
            <script>
        /* Google Sheets API Integration */
        const CLIENT_ID = '100558746198-i2g0mtl8ukh391ie58jfcvnhla8tdt15.apps.googleusercontent.com';
        const SPREADSHEET_ID = '1XENW-Ay-0C_ehIZgIYryMrnvCKl5VQ5PJIjFWGdqRMc';
        const SCOPES = 'https://www.googleapis.com/auth/spreadsheets';

        let tokenClient;
        let gapiInited = false;
        let gisInited = false;

        const authButton = document.getElementById('authButton');
        const signoutButton = document.getElementById('signoutButton');
        const addTransactionBtn = document.getElementById('addTransactionBtn');

        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            await gapi.client.init({
                discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
            });
            gapiInited = true;
            maybeEnableButtons();
        }

        function gisLoaded() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: SCOPES,
                callback: (tokenResponse) => {
                    if (tokenResponse && tokenResponse.access_token) {
                        updateAuthStatus(true);
                    }
                },
            });
            gisInited = true;
            maybeEnableButtons();
        }

        function maybeEnableButtons() {
            if (gapiInited && gisInited) {
                authButton.style.display = 'block';
                authButton.onclick = handleAuthClick;
                signoutButton.onclick = handleSignoutClick;
            }
        }
        
        function handleAuthClick() {
            tokenClient.callback = (resp) => {
                if (resp.error !== undefined) {
                    throw (resp);
                }
                updateAuthStatus(true);
                 // Automatically load transactions after successful auth
                loadTransactions();
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }
        
        function handleSignoutClick() {
            const token = gapi.client.getToken();
            if (token !== null) {
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
                updateAuthStatus(false);
            }
        }

        function updateAuthStatus(isAuthorized) {
            if (isAuthorized) {
                authButton.style.display = 'none';
                signoutButton.style.display = 'block';
                addTransactionBtn.style.display = 'block';
            } else {
                authButton.style.display = 'block';
                signoutButton.style.display = 'none';
                addTransactionBtn.style.display = 'none';
            }
        }

        const GOOGLE_SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSbgsM-j_c69k_zvY9-kT7cpkFZCed7qB9U9ARl8qICGslPo5y6UEAkUw4FIacq7wjUK6HHurDAZODc/pub?output=csv';

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = lines[0].split(',').map(header => header.trim()); // Trim headers to remove potential whitespace
            const result = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',');
                if (values.length !== headers.length) {
                    console.warn(`Skipping malformed row: ${lines[i]}`);
                    continue; // Skip rows that don't match header count
                }
                const obj = {};
                for (let j = 0; j < headers.length; j++) {
                    let value = values[j].trim(); // Trim values
                    // Attempt to convert 'amount' to a number
                    if (headers[j] === 'amount') {
                        obj[headers[j]] = parseFloat(value);
                    } else {
                        obj[headers[j]] = value;
                    }
                }
                result.push(obj);
            }
            return result;
        }

        let transactions = [];
        let filteredTransactions = [];

        // Load Transactions
        async function loadTransactions() {
            try {
                const response = await fetch(GOOGLE_SHEET_CSV_URL);
                if (!response.ok) {
                    throw new Error('無法載入 Google Sheet 資料');
                }
                const csvText = await response.text();
                transactions = parseCSV(csvText); // Use the new parseCSV function
                filteredTransactions = [...transactions];

                populateFilters();
                updateDashboard();
                renderTransactions();
            } catch (error) {
                console.error('載入資料時發生錯誤:', error);
                document.getElementById('tableContainer').innerHTML =
                    '<div class="error-message">無法載入 Google Sheet 交易記錄。請確認連結正確且檔案格式正確。<br>錯誤訊息: ' + error.message + '</div>';
            }
        }

        // Update Dashboard
        function updateDashboard() {
            let totalBuy = 0;
            let totalSell = 0;
            let totalDividend = 0;

            // Stock statistics for inventory calculation
            const stockStats = {};

            transactions.forEach(t => {
                if (t.type === 'buy') {
                    totalBuy += t.amount;

                    // Track per stock
                    if (t.stockCode && t.stockCode !== '-') {
                        if (!stockStats[t.stockCode]) {
                            stockStats[t.stockCode] = { buyAmount: 0, sellAmount: 0 };
                        }
                        stockStats[t.stockCode].buyAmount += t.amount;
                    }
                } else if (t.type === 'sell') {
                    totalSell += t.amount;

                    // Track per stock
                    if (t.stockCode && t.stockCode !== '-') {
                        if (!stockStats[t.stockCode]) {
                            stockStats[t.stockCode] = { buyAmount: 0, sellAmount: 0 };
                        }
                        stockStats[t.stockCode].sellAmount += t.amount;
                    }
                } else if (t.type === 'dividend') {
                    totalDividend += t.amount;
                } else if (t.type === 'capital_gain') {
                    // capital_gain 不計入 totalDividend，因為價差已由 sell - buy 計算
                    // 只影響資料的完整性，不影響已實現損益
                }
            });

            // Calculate inventory cost (unrealized holdings)
            let totalInventoryCost = 0;
            Object.keys(stockStats).forEach(stock => {
                const stats = stockStats[stock];
                if (stats.buyAmount > stats.sellAmount) {
                    totalInventoryCost += (stats.buyAmount - stats.sellAmount);
                }
            });

            // Trading profit = total sell - total buy + inventory cost (exclude unrealized)
            const tradingProfit = totalSell - totalBuy + totalInventoryCost;

            // Realized profit = trading profit + dividend
            const realizedProfit = tradingProfit + totalDividend;

            document.getElementById('totalTransactions').textContent = transactions.length;
            document.getElementById('totalInvested').textContent = 'NT$ ' + totalBuy.toLocaleString();
            document.getElementById('totalReturned').textContent = 'NT$ ' + totalSell.toLocaleString();

            const profitElement = document.getElementById('realizedProfit');
            profitElement.textContent = 'NT$ ' + realizedProfit.toLocaleString();
            profitElement.className = 'value ' + (realizedProfit >= 0 ? 'positive' : 'negative');
        }

        // Populate Filters
        function populateFilters() {
            // Stock codes
            const stocks = [...new Set(transactions.map(t => t.stockCode).filter(s => s))].sort();
            const stockFilter = document.getElementById('stockFilter');
            // Clear existing options before populating
            stockFilter.innerHTML = '<option value="">全部股票</option>';
            stocks.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock;
                option.textContent = stock;
                stockFilter.appendChild(option);
            });

            // Brokers
            const brokers = [...new Set(
                transactions.flatMap(t => [t.from, t.to])
                    .filter(b => b && b !== '' && b !== '總證券戶')
            )].sort();
            const brokerFilter = document.getElementById('brokerFilter');
            brokerFilter.innerHTML = '<option value="">全部證券商</option>';
            brokers.forEach(broker => {
                const option = document.createElement('option');
                option.value = broker;
                option.textContent = broker;
                brokerFilter.appendChild(option);
            });

            // Notes
            const notes = [...new Set(transactions.map(t => t.note).filter(n => n))].sort();
            const noteFilter = document.getElementById('noteFilter');
            noteFilter.innerHTML = '<option value="">全部備註</option>';
            notes.forEach(note => {
                const option = document.createElement('option');
                option.value = note;
                option.textContent = note;
                noteFilter.appendChild(option);
            });
        }

        // Apply Filters
        function applyFilters() {
            const stockFilter = document.getElementById('stockFilter').value;
            const brokerFilter = document.getElementById('brokerFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const noteFilter = document.getElementById('noteFilter').value;

            filteredTransactions = transactions.filter(transaction => {
                let matches = true;

                if (stockFilter && transaction.stockCode !== stockFilter) matches = false;
                if (brokerFilter && transaction.from !== brokerFilter && transaction.to !== brokerFilter) matches = false;
                if (typeFilter && transaction.type !== typeFilter) matches = false;
                if (noteFilter && transaction.note !== noteFilter) matches = false;

                return matches;
            });

            renderTransactions();
        }

        // Reset Filters
        function resetFilters() {
            document.getElementById('stockFilter').value = '';
            document.getElementById('brokerFilter').value = '';
            document.getElementById('typeFilter').value = '';
            document.getElementById('noteFilter').value = '';

            filteredTransactions = [...transactions];
            renderTransactions();
        }

        // Render Transactions
        function renderTransactions() {
            const container = document.getElementById('tableContainer');
            const recordCount = document.getElementById('recordCount');

            if (transactions.length === 0) {
                container.innerHTML = '<div class="empty-state">尚無交易記錄</div>';
                recordCount.textContent = '';
                return;
            }

            if (filteredTransactions.length === 0) {
                container.innerHTML = '<div class="empty-state">查無符合條件的交易記錄</div>';
                recordCount.textContent = '(0 筆)';
                return;
            }

            recordCount.textContent = `共 ${filteredTransactions.length} 筆`;

            // Sort by date
            const sortedTransactions = [...filteredTransactions].sort((a, b) =>
                new Date(a.date) - new Date(b.date)
            );

            // Calculate balance (only for transactions involving 總證券戶)
            let balance = 0;
            sortedTransactions.forEach(t => {
                if (t.type === 'buy' && t.to === '總證券戶') {
                    // 買入進總證券戶：增加
                    balance += t.amount;
                } else if (t.type === 'sell' && t.from === '總證券戶') {
                    // 從總證券戶賣出：減少
                    balance -= t.amount;
                } else if (t.type === 'capital_gain') {
                    // 買賣價差：永遠計入總證券戶
                    balance += t.amount;
                }
                // 注意：股利 (dividend) 不計入總證券戶餘額
                t.balance = balance;
            });

            // Reverse for display (newest first)
            sortedTransactions.reverse();

            const typeText = {
                'buy': '買入',
                'sell': '賣出',
                'dividend': '現金股利',
                'capital_gain': '買賣價差'
            };

            const tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>類型</th>
                            <th>股票代碼</th>
                            <th>來源</th>
                            <th>目的</th>
                            <th>金額</th>
                            <th>總證券戶餘額</th>
                            <th>備註</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sortedTransactions.map(t => {
                            const amountClass = `amount-${t.type.replace('_', '-')}`;
                            const amountDisplay = t.amount !== 0 ? `NT$ ${t.amount.toLocaleString()}` : '-';
                            const balanceClass = t.balance >= 0 ? 'amount-positive' : 'amount-negative';

                            return `
                                <tr>
                                    <td>${t.date}</td>
                                    <td><span class="type-badge ${t.type}">${typeText[t.type]}</span></td>
                                    <td><span class="stock-code">${t.stockCode || '-'}</span></td>
                                    <td>${t.from || '-'}</td>
                                    <td>${t.to || '-'}</td>
                                    <td class="${amountClass}">${amountDisplay}</td>
                                    <td class="${balanceClass}">NT$ ${t.balance.toLocaleString()}</td>
                                    <td>${t.note || '-'}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;

            container.innerHTML = tableHTML;
        }

        // ==================== Add Transaction Modal Logic ====================
        const modal = document.getElementById('addModal');
        const cancelBtn = document.getElementById('cancelBtn');
        const addTransactionForm = document.getElementById('addTransactionForm');

        if (addTransactionBtn && modal && cancelBtn && addTransactionForm) {
            // Open modal
            addTransactionBtn.addEventListener('click', () => {
                // Set default date to today
                document.getElementById('form-date').value = new Date().toISOString().split('T')[0];
                modal.style.display = 'flex';
            });

            // Close modal
            cancelBtn.addEventListener('click', () => {
                modal.style.display = 'none';
                addTransactionForm.reset();
            });

            // Close modal on outside click
            modal.addEventListener('click', (event) => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                    addTransactionForm.reset();
                }
            });

            // Handle form submission
            addTransactionForm.addEventListener('submit', async (event) => {
                event.preventDefault();

                // 1. Get data from form and create the row array
                const values = [
                    document.getElementById('form-date').value,
                    document.getElementById('form-type').value,
                    document.getElementById('form-from').value,
                    document.getElementById('form-to').value,
                    document.getElementById('form-stockCode').value,
                    document.getElementById('form-amount').value,
                    document.getElementById('form-note').value
                ];

                try {
                    // 2. Append data to Google Sheet
                    const response = await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SPREADSHEET_ID,
                        range: 'transactions!A:G', // Assuming data is in Sheet1, adjust if necessary
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [values],
                        },
                    });
                    
                    if (response.status === 200) {
                        alert('交易已成功新增！');
                        // 3. Close modal and reset form
                        modal.style.display = 'none';
                        addTransactionForm.reset();

                        // 4. Re-load transactions from sheet to refresh the UI
                        loadTransactions();
                    } else {
                         throw new Error('Failed to append data.');
                    }

                } catch (err) {
                    console.error('ERROR:', err.body);
                    alert('新增交易失敗，請檢查 Console 中的錯誤訊息。');
                }
            });
        }

        // Initialize
        loadTransactions();


    </script>
</body>
</html>